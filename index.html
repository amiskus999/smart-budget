
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budgeting</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Custom styles for the app */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        /* Dark mode styles */
        body.dark {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }

        body.dark .bg-white {
            background-color: #2d3748; /* Darker card background */
            color: #e2e8f0;
        }

        body.dark .border-gray-200 {
            border-color: #4a5568;
        }

        body.dark input,
        body.dark select,
        body.dark textarea { /* Added textarea to dark mode styles */
            background-color: #4a5568;
            color: #e2e8f0;
            border-color: #6b7280;
        }

        body.dark input::placeholder,
        body.dark textarea::placeholder { /* Added textarea placeholder */
            color: #a0aec0;
        }

        body.dark button {
            background-color: #4c51bf; /* Darker button color, general for most buttons */
        }

        body.dark button:hover {
            background-color: #5a62c9;
        }

        /* Specific styles for the remove button to keep it red in dark mode */
        body.dark .remove-expense {
            background-color: #ef4444; /* Tailwind red-500 */
        }

        body.dark .remove-expense:hover {
            background-color: #dc2626; /* Tailwind red-600 */
        }

        /* Specific styles for the save budget button to keep it green in dark mode */
        body.dark #saveBudgetBtn {
            background-color: #22c55e; /* Tailwind green-500 */
        }

        body.dark #saveBudgetBtn:hover {
            background-color: #16a34a; /* Tailwind green-600 */
        }

        body.dark .text-gray-700 {
            color: #cbd5e0;
        }

        body.dark .chart-container {
            background-color: #2d3748; /* Darker chart background */
            border-color: #4a5568;
        }

        /* Responsive adjustments for expense items */
        .expense-item {
            display: flex;
            align-items: center;
            gap: 0.5rem; /* Consistent spacing */
            flex-wrap: wrap; /* Allow wrapping on small screens */
        }

        .expense-item .expense-name {
            flex-grow: 1; /* Allows it to take available space */
            min-width: 120px; /* Minimum width to ensure readability */
        }

        .expense-item .expense-value,
        .expense-item .expense-type {
            flex-shrink: 0; /* Prevents these from shrinking too much */
            flex-basis: calc(50% - 0.5rem); /* Take roughly half width on small screens */
            max-width: 140px; /* Max width to prevent them from becoming too wide */
        }

        .expense-item .remove-expense {
            flex-shrink: 0; /* Prevents button from shrinking */
            margin-left: auto; /* Push button to the right if space allows */
            order: 1; /* Keep its order consistent */
        }

        @media (max-width: 480px) { /* For very small screens, stack more aggressively */
            .expense-item .expense-value,
            .expense-item .expense-type {
                flex-basis: calc(100% - 0.5rem); /* Each takes full width, stacking */
                max-width: none; /* Remove max-width constraint */
            }
            .expense-item .remove-expense {
                margin-left: 0; /* Remove auto margin when stacked fully */
                width: 100%; /* Make button take full width to be more tap-friendly */
            }
        }

        /* Print specific styles */
        @media print {
            /* Hide elements that shouldn't be printed */
            .no-print, header,
            .grid > section:first-child .mb-4:first-child, /* Month select div */
            .grid > section:first-child #addExpenseBtn,
            .grid > section:first-child #saveBudgetBtn,
            .grid > section:first-child #printBudgetBtn, /* Hide print button itself */
            #expenseCategorySelect, /* Hide individual chart category select */
            .remove-expense, /* Hide remove buttons in expenses */
            .expense-type, /* Hide percentage/amount dropdowns in expenses */
            #feedbackSection /* Hide the entire feedback section */ {
                display: none !important;
            }

            /* Make sure inputs appear as plain text when printed */
            .expense-name, .expense-value, #incomeInput {
                border: none !important;
                background: none !important;
                padding: 0 !important;
                margin: 0 !important;
                display: inline !important; /* To make them flow naturally */
                width: auto !important;
                box-shadow: none !important;
                color: black !important; /* Ensure text is black for print */
            }

            /* Adjust the layout of expense items for printing */
            #expensesContainer .expense-item {
                display: flex !important; /* Keep as flex to align name and value */
                justify-content: space-between !important; /* Space between name and value */
                padding: 0.2rem 0 !important;
                border-bottom: 1px dashed #ccc !important; /* Subtle separator */
                margin-bottom: 0.2rem !important;
            }

            /* Make sure charts and summaries are visible and fill space */
            .container {
                width: 100% !important;
                max-width: none !important;
                padding: 0 !important;
            }
            .grid {
                grid-template-columns: 1fr !important; /* Stack sections for print */
                gap: 0 !important;
            }
            section {
                box-shadow: none !important;
                border: none !important;
                margin-top: 0 !important;
                padding: 1rem !important;
            }
            .chart-container {
                padding: 0.5rem !important;
                box-shadow: none !important;
                border: none !important;
            }
            /* Ensure text color is black for print */
            body, h1, h2, h3, p, span, strong {
                color: black !important;
            }
            /* Ensure dark mode elements don't affect print */
            body.dark .bg-white,
            body.dark .chart-container {
                background-color: white !important;
                color: black !important;
            }
            body.dark .border-gray-200 {
                border-color: #e2e8f0 !important;
            }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-900 min-h-screen flex flex-col items-center">
    <div class="container mx-auto p-6 max-w-4xl w-full">
        <!-- Header -->
        <header class="flex justify-between items-center mb-8 no-print">
            <h1 class="text-4xl font-extrabold text-blue-600">Smart Budget</h1>
            <div class="flex space-x-2">
                <button id="themeToggle" class="px-4 py-2 rounded-full bg-gray-200 text-gray-800 dark:bg-gray-700 dark:text-gray-200 shadow-md transition-colors duration-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                    <!-- Icon will be set dynamically by JavaScript -->
                </button>
            </div>
        </header>

        <!-- Main Content Grid -->
        <!-- Changed to grid-cols-1 for single column (full width) layout on all screen sizes -->
        <div class="grid grid-cols-1 gap-8 mb-8">
            <!-- Budget Input Section - Now takes full width by default -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200">
                <h2 class="text-2xl font-bold mb-6 text-gray-700">Set Your Budget</h2>

                <!-- Month Selector with Navigation Buttons -->
                <div class="mb-4">
                    <label for="monthSelect" class="block text-sm font-medium text-gray-700 mb-1">Select Month:</label>
                    <div class="flex items-center space-x-2">
                        <button id="prevMonthBtn" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200 shadow-sm">‚Üê</button>
                        <select id="monthSelect" class="mt-1 block flex-grow pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                            <!-- Options will be dynamically added here by JavaScript -->
                        </select>
                        <button id="nextMonthBtn" class="px-3 py-2 bg-blue-500 text-white rounded-md hover:bg-blue-600 transition-colors duration-200 shadow-sm">‚Üí</button>
                    </div>
                </div>

                <!-- Income Input -->
                <div class="mb-4">
                    <label for="incomeInput" class="block text-sm font-medium text-gray-700 mb-1">Income üí∞:</label>
                    <input type="number" id="incomeInput" placeholder="e.g., 3000" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 p-2">
                </div>

                <!-- Expense Input Area -->
                <div id="expensesContainer" class="mb-6 space-y-4">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Expenses:</h3>
                    <!-- Expense items will be dynamically added here -->
                    <div class="expense-item flex flex-wrap items-center gap-2 mb-2">
                        <input type="text" placeholder="Expense Name (e.g., Rent)" class="expense-name flex-1 min-w-[120px] rounded-md border-gray-300 shadow-sm p-2">
                        <input type="number" placeholder="Amount" class="expense-value w-28 sm:flex-1 sm:max-w-[140px] rounded-md border-gray-300 shadow-sm p-2">
                        <select class="expense-type w-20 sm:flex-1 sm:max-w-[140px] rounded-md border-gray-300 shadow-sm p-2">
                            <option value="amount">$</option>
                            <option value="percentage">%</option>
                        </select>
                        <button class="remove-expense w-8 h-8 flex-shrink-0 flex items-center justify-center bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-xl font-bold">
                                <!-- Trash Bin SVG Icon -->
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-5 h-5">
                                    <path fill-rule="evenodd" d="M16.5 4.478a.75.75 0 0 0-1.124-.03L9.42 11.026 5.854 7.46a.75.75 0 0 0-1.06 1.06l4.5 4.5a.75.75 0 0 0 1.06 0l7.5-7.5a.75.75 0 0 0 0-1.06Z" clip-rule="evenodd" />
                                </svg>
                            </button>
                    </div>
                </div>
                <button id="addExpenseBtn" class="w-full bg-blue-500 text-white py-2 rounded-md hover:bg-blue-600 transition-colors duration-200 mb-4 shadow-md">‚ûï Add Expense</button>

                <button id="saveBudgetBtn" class="w-full bg-green-500 text-white py-3 rounded-md hover:bg-green-600 transition-colors duration-200 shadow-md text-lg font-semibold">Save Budget</button>
                <button id="printBudgetBtn" class="w-full mt-4 bg-purple-600 text-white py-3 rounded-md hover:bg-purple-700 transition-colors duration-200 shadow-md text-lg font-semibold">üñ®Ô∏è Print Budget</button>
            </section>

            <!-- Budget Summary & Chart Section - Now takes full width by default -->
            <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 flex flex-col">
                <h2 class="text-2xl font-bold mb-6 text-gray-700">Budget Overview</h2>
                <div id="budgetSummary" class="mb-6 space-y-2 text-lg">
                    <!-- Budget summary will be displayed here -->
                    <p><strong>Selected Month:</strong> <span id="summaryMonth"></span></p>
                    <p><strong>Income üí∞:</strong> $<span id="summaryIncome">0.00</span></p>
                    <p><strong>Total $ Spent:</strong> $<span id="summaryExpenses">0.00</span></p>
                    <p><strong>Remaining $:</strong> $<span id="summaryRemaining" class="font-bold">0.00</span></p>
                </div>

                <!-- Detailed Expenses List (new section) -->
                <div id="detailedExpenses" class="mt-6 border-t pt-4 border-gray-200">
                    <h3 class="text-xl font-semibold mb-3 text-gray-700">Allocated Expenses:</h3>
                    <div id="detailedExpensesList" class="space-y-1 text-base">
                        <!-- Detailed expenses will be populated here -->
                    </div>
                </div>


                <!-- Chart Container -->
                <div class="flex-grow bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-100 chart-container mt-6">
                    <canvas id="spendingChart"></canvas>
                </div>
            </section>
        </div>

        <!-- Individual Expense History Section -->
        <section class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Individual Expense History</h2>

            <div class="mb-4 no-print">
                <label for="expenseCategorySelect" class="block text-sm font-medium text-gray-700 mb-1">Select Expense Category:</label>
                <select id="expenseCategorySelect" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm rounded-md shadow-sm">
                    <option value="">-- Select a category --</option>
                    <!-- Expense categories will be dynamically added here by JavaScript -->
                </select>
            </div>

            <div class="flex-grow bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-100 chart-container">
                <canvas id="individualExpenseChart"></canvas>
            </div>
        </section>

        <!-- Feedback Section -->
        <section id="feedbackSection" class="bg-white p-6 rounded-xl shadow-lg border border-gray-200 mt-8 no-print">
            <h2 class="text-2xl font-bold mb-6 text-gray-700">Send Us Feedback!</h2>
            <!-- Google Form embedded here -->
            <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSetNl1PiGqjILYt5iFZ2XRXyps6RMG3xxkROC6XHOU0bS-xPA/viewform?embedded=true" 
                    width="100%" 
                    height="500" 
                    frameborder="0" 
                    marginheight="0" 
                    marginwidth="0"
                    class="rounded-md shadow-md">Loading...</iframe>
        </section>
    </div>

    <script>
        // JavaScript for Budgeting App

        // DOM Elements
        const themeToggle = document.getElementById('themeToggle');
        const monthSelect = document.getElementById('monthSelect');
        const incomeInput = document.getElementById('incomeInput');
        const expensesContainer = document.getElementById('expensesContainer');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const saveBudgetBtn = document.getElementById('saveBudgetBtn');
        const budgetSummary = document.getElementById('budgetSummary');
        const summaryMonth = document.getElementById('summaryMonth');
        const summaryIncome = document.getElementById('summaryIncome');
        const summaryExpenses = document.getElementById('summaryExpenses');
        const summaryRemaining = document.getElementById('summaryRemaining');
        const spendingChartCanvas = document.getElementById('spendingChart');
        const printBudgetBtn = document.getElementById('printBudgetBtn'); 

        const detailedExpensesList = document.getElementById('detailedExpensesList'); // New DOM element for detailed expenses


        // New DOM Elements for month navigation
        const prevMonthBtn = document.getElementById('prevMonthBtn');
        const nextMonthBtn = document.getElementById('nextMonthBtn');

        // New DOM elements for individual expense history
        const expenseCategorySelect = document.getElementById('expenseCategorySelect');
        const individualExpenseChartCanvas = document.getElementById('individualExpenseChart');

        // Chart instances
        let spendingChart;
        let individualExpenseChart; 

        // Data Structure: budgets will be an object where keys are month-year strings (e.g., "2023-01")
        // and values are objects containing income, expenses array.
        let budgets = {}; 

        // Constants
        const LOCAL_STORAGE_KEY = 'smartBudgetAppData';

        /**
         * Initializes the application: loads data, sets up UI, and renders initial state.
         */
        document.addEventListener('DOMContentLoaded', async () => {
            loadBudgets();
            populateMonthSelect();
            renderCurrentMonthBudget();
            updateChart(); 
            populateExpenseCategoriesSelect(); 
            updateIndividualExpenseChart(); 
            applySavedTheme();
            updateThemeToggleButton(); 

            // Moved event listeners inside DOMContentLoaded to ensure elements are loaded
            printBudgetBtn.addEventListener('click', () => {
                updateChart(); // Ensure charts are up-to-date before printing
                updateIndividualExpenseChart(expenseCategorySelect.value);

                window.print(); // Trigger the browser's print dialog

                const restoreCharts = () => {
                    updateChart(); // Re-render main chart
                    updateIndividualExpenseChart(expenseCategorySelect.value); // Re-render individual chart
                    window.removeEventListener('afterprint', restoreCharts); // Clean up the listener
                };
                window.addEventListener('afterprint', restoreCharts);
            });
        });

        /**
         * Updates the theme toggle button's text content with appropriate emoji.
         */
        function updateThemeToggleButton() {
            const isDarkMode = document.body.classList.contains('dark');
            themeToggle.textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
        }

        /**
         * Toggles between light and dark mode themes.
         * Saves the current theme preference to local storage.
         */
        themeToggle.addEventListener('click', () => {
            document.body.classList.toggle('dark');
            const isDarkMode = document.body.classList.contains('dark');
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            updateThemeToggleButton(); 
            // Re-render both charts to pick up theme colors
            updateChart();
            updateIndividualExpenseChart(expenseCategorySelect.value);
        });

        /**
         * Applies the theme preference saved in local storage.
         */
        function applySavedTheme() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.body.classList.add('dark');
            }
        }

        /**
         * Generates month options for the month selector.
         * Includes the current month, previous 11 months, and up to the year 2070.
         */
        function populateMonthSelect() {
            monthSelect.innerHTML = ''; 
            const today = new Date();
            const currentMonth = today.getMonth();
            const currentYear = today.getFullYear();

            // Add past 11 months (total 12 months including current)
            for (let i = 11; i >= 0; i--) { 
                const date = new Date(currentYear, currentMonth - i, 1);
                const monthName = date.toLocaleString('default', { month: 'long' });
                const year = date.getFullYear();
                const monthValue = `${year}-${String(date.getMonth() + 1).padStart(2, '0')}`; 
                const option = document.createElement('option');
                option.value = monthValue;
                option.textContent = `${monthName} ${year}`;
                monthSelect.appendChild(option);
            }

            // Add months up to the year 2070
            const endYear = 2070;
            for (let y = currentYear; y <= endYear; y++) {
                for (let m = 0; m < 12; m++) {
                    // For the current year, only add future months (after currentMonth)
                    if (y === currentYear && m < currentMonth) {
                        continue;
                    }

                    const date = new Date(y, m, 1);
                    const monthName = date.toLocaleString('default', { month: 'long' });
                    const year = date.getFullYear();
                    const monthValue = `${year}-${String(date.getMonth() + 1).padStart(2, '0')}`; 

                    // Only add if not already present (prevents duplicates for current year's remaining months)
                    if (!Array.from(monthSelect.options).some(opt => opt.value === monthValue)) {
                        const option = document.createElement('option');
                        option.value = monthValue;
                        option.textContent = `${monthName} ${year}`;
                        monthSelect.appendChild(option);
                    }
                }
            }

            // Set the current month as selected by default
            const currentMonthFormatted = `${currentYear}-${String(currentMonth + 1).padStart(2, '0')}`;
            monthSelect.value = currentMonthFormatted;
        }

        /**
         * Event listener for when the selected month changes.
         * Renders the budget data for the newly selected month.
         */
        monthSelect.addEventListener('change', renderCurrentMonthBudget);

        /**
         * Navigates to the previous month in the month selector.
         */
        prevMonthBtn.addEventListener('click', () => {
            const currentIndex = monthSelect.selectedIndex;
            if (currentIndex > 0) {
                monthSelect.selectedIndex = currentIndex - 1;
                renderCurrentMonthBudget();
            }
        });

        /**
         * Navigates to the next month in the month selector.
         */
        nextMonthBtn.addEventListener('click', () => {
            const currentIndex = monthSelect.selectedIndex;
            if (currentIndex < monthSelect.options.length - 1) {
                monthSelect.selectedIndex = currentIndex + 1;
                renderCurrentMonthBudget();
            }
        });

        /**
         * Creates a new expense input row and appends it to the expenses container.
         * Includes input fields for name, value, type (amount/percentage), and a remove button.
         */
        addExpenseBtn.addEventListener('click', () => {
            addExpenseRow({ name: '', value: '', type: 'amount' });
        });

        /**
         * Adds a single expense row to the expenses container.
         * @param {Object} expenseData - Initial data for the expense row (name, value, type).
         */
        function addExpenseRow(expenseData = { name: '', value: '', type: 'amount' }) {
            const expenseItem = document.createElement('div');
            expenseItem.className = 'expense-item flex flex-wrap items-center gap-2 mb-2'; 

            expenseItem.innerHTML = `
                <input type="text" placeholder="Expense Name (e.g., Rent)" class="expense-name flex-1 min-w-[120px] rounded-md border-gray-300 shadow-sm p-2">
                <input type="number" placeholder="Amount" class="expense-value w-28 sm:flex-1 sm:max-w-[140px] rounded-md border-gray-300 shadow-sm p-2">
                <select class="expense-type w-20 sm:flex-1 sm:max-w-[140px] rounded-md border-gray-300 shadow-sm p-2">
                    <option value="amount" ${expenseData.type === 'amount' ? 'selected' : ''}>$</option>
                    <option value="percentage" ${expenseData.type === 'percentage' ? 'selected' : ''}>%</option>
                </select>
                <button class="remove-expense w-8 h-8 flex-shrink-0 flex items-center justify-center bg-red-500 text-white rounded-md hover:bg-red-600 transition-colors duration-200 text-xl font-bold ml-auto sm:ml-0">‚àí</button>
            `;
            expensesContainer.appendChild(expenseItem);

            // Add event listener for the new remove button
            expenseItem.querySelector('.remove-expense').addEventListener('click', () => {
                expenseItem.remove();
                // Re-calculate and update summary/chart after removal
                updateBudgetSummary();
                updateChart();
                populateExpenseCategoriesSelect(); 
                updateIndividualExpenseChart(expenseCategorySelect.value); 
            });

            // Add event listeners for input changes to update summary and chart in real-time
            expenseItem.querySelector('.expense-name').addEventListener('input', () => {
                updateBudgetSummary();
                updateChart();
                // If expense name changes, categories might need updating
                populateExpenseCategoriesSelect();
                updateIndividualExpenseChart(expenseCategorySelect.value);
            });
            expenseItem.querySelector('.expense-value').addEventListener('input', () => {
                updateBudgetSummary();
                updateChart();
                updateIndividualExpenseChart(expenseCategorySelect.value);
            });
            expenseItem.querySelector('.expense-type').addEventListener('change', () => {
                updateBudgetSummary();
                updateChart();
                updateIndividualExpenseChart(expenseCategorySelect.value);
            });
        }

        /**
         * Clears all existing expense input rows from the container.
         */
        function clearExpenseRows() {
            expensesContainer.innerHTML = '';
        }

        /**
         * Renders the budget data for the currently selected month.
         * Populates income, expense inputs, and updates the summary.
         */
        function renderCurrentMonthBudget() {
            const selectedMonth = monthSelect.value;
            const monthData = budgets[selectedMonth];

            clearExpenseRows(); 

            if (monthData) {
                incomeInput.value = monthData.income;
                monthData.expenses.forEach(expense => addExpenseRow(expense));
            } else {
                // If no data for this month, reset inputs and add a default expense row
                incomeInput.value = '';
                addExpenseRow(); 
            }
            updateBudgetSummary(); 
        }

        /**
         * Collects the budget data from the input fields.
         * @returns {Object} An object containing income and an array of expenses.
         */
        function getCurrentBudgetInputs() {
            const income = parseFloat(incomeInput.value) || 0;
            const expenses = [];

            document.querySelectorAll('.expense-item').forEach(item => {
                const name = item.querySelector('.expense-name').value.trim();
                const value = parseFloat(item.querySelector('.expense-value').value) || 0;
                const type = item.querySelector('.expense-type').value;

                if (name) { 
                    expenses.push({ name, value, type });
                }
            });
            return { income, expenses };
        }

        /**
         * Calculates the total expenses and remaining budget for the current month.
         * Updates the budget summary display.
         */
        function updateBudgetSummary() {
            const { income, expenses } = getCurrentBudgetInputs();
            const selectedMonthText = monthSelect.options[monthSelect.selectedIndex].text;

            let totalExpenses = 0;
            detailedExpensesList.innerHTML = ''; // Clear previous detailed expenses

            if (expenses.length > 0) {
                expenses.forEach(expense => {
                    let expenseAmount = 0;
                    if (expense.type === 'amount') {
                        expenseAmount = expense.value;
                    } else if (expense.type === 'percentage') {
                        expenseAmount = (income * (expense.value / 100));
                    }
                    totalExpenses += expenseAmount;

                    // Add to detailed expenses list
                    const expenseItem = document.createElement('p');
                    expenseItem.className = 'flex justify-between items-center text-lg font-semibold text-gray-900 dark:text-gray-900';
                    expenseItem.innerHTML = `<span>${expense.name}:</span> <span class="font-medium">$${expenseAmount.toFixed(2)}</span>`;
                    detailedExpensesList.appendChild(expenseItem);
                });
            } else {
                detailedExpensesList.innerHTML = '<p class="text-gray-900 italic dark:text-gray-900 text-lg font-semibold">No expenses allocated for this month.</p>';
            }


            const remainingBudget = income - totalExpenses;

            summaryMonth.textContent = selectedMonthText; 
            summaryIncome.textContent = income.toFixed(2);
            summaryExpenses.textContent = totalExpenses.toFixed(2);
            summaryRemaining.textContent = remainingBudget.toFixed(2);

            // Highlight remaining budget based on its value
            summaryRemaining.classList.remove('text-green-600', 'text-red-600');
            if (remainingBudget >= 0) {
                summaryRemaining.classList.add('text-green-600');
            } else {
                summaryRemaining.classList.add('text-red-600');
            }
        }

        // Add input event listeners to income and all expense fields for real-time updates
        incomeInput.addEventListener('input', updateBudgetSummary);
        expensesContainer.addEventListener('input', (event) => {
            if (event.target.classList.contains('expense-name') ||
                event.target.classList.contains('expense-value') ||
                event.target.classList.contains('expense-type')) {
                updateBudgetSummary();
            }
        });

        /**
         * Saves the current month's budget data to the `budgets` object and local storage.
         */
        saveBudgetBtn.addEventListener('click', () => {
            const selectedMonth = monthSelect.value;
            const { income, expenses } = getCurrentBudgetInputs();

            budgets[selectedMonth] = { income, expenses };
            saveBudgets(); 
            updateChart(); 
            populateExpenseCategoriesSelect(); 
            updateIndividualExpenseChart(expenseCategorySelect.value); 
            alertUser('Budget Saved! ‚ú®'); 
        });

        /**
         * Loads budget data from local storage into the `budgets` object.
         */
        function loadBudgets() {
            const savedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (savedData) {
                try {
                    budgets = JSON.parse(savedData);
                } catch (e) {
                    console.error("Error parsing stored budget data:", e);
                    budgets = {}; 
                }
            } else {
                budgets = {};
            }
        }

        /**
         * Saves the current `budgets` object to local storage.
         */
        function saveBudgets() {
            localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(budgets));
        }

        /**
         * Updates the spending history chart using Chart.js.
         * Displays total income and total expenses for each month.
         */
        function updateChart() {
            const monthLabels = [];
            const incomeData = [];
            const expensesData = [];

            // Sort months chronologically for chart display
            const sortedMonths = Object.keys(budgets).sort((a, b) => {
                return new Date(a) - new Date(b);
            });

            sortedMonths.forEach(monthKey => {
                const monthData = budgets[monthKey];
                const [year, monthNum] = monthKey.split('-');
                const monthName = new Date(year, parseInt(monthNum) - 1).toLocaleString('default', { month: 'short' });
                monthLabels.push(`${monthName} ${year}`);
                incomeData.push(monthData.income);

                let totalExpenses = 0;
                monthData.expenses.forEach(expense => {
                    if (expense.type === 'amount') {
                        totalExpenses += expense.value;
                    } else if (expense.type === 'percentage') {
                        totalExpenses += (monthData.income * (expense.value / 100));
                    }
                });
                expensesData.push(totalExpenses);
            });

            const chartData = {
                labels: monthLabels,
                datasets: [
                    {
                        label: 'üí∞', 
                        data: incomeData,
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.2)',
                        tension: 0.1,
                        fill: true
                    },
                    {
                        label: '$ Spent', 
                        data: expensesData,
                        borderColor: 'rgb(255, 99, 132)',
                        backgroundColor: 'rgba(255, 99, 132, 0.2)',
                        tension: 0.1,
                        fill: true
                    }
                ]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false, 
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: document.body.classList.contains('dark') ? '#e2e8f0' : '#4a5568'
                        }
                    },
                    title: {
                        display: true,
                        text: 'Monthly Income vs. Expenses',
                        color: document.body.classList.contains('dark') ? '#e2e8f0' : '#4a5568'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: document.body.classList.contains('dark') ? '#cbd5e0' : '#4a5568'
                        },
                        grid: {
                            color: document.body.classList.contains('dark') ? '#4a5568' : '#e2e8f0'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: document.body.classList.contains('dark') ? '#cbd5e0' : '#4a5568'
                        },
                        grid: {
                            color: document.body.classList.contains('dark') ? '#4a5568' : '#e2e8f0'
                        }
                    }
                }
            };

            if (spendingChart) {
                spendingChart.destroy(); 
            }

            spendingChart = new Chart(spendingChartCanvas, {
                type: 'line',
                data: chartData,
                options: chartOptions
            });
        }

        /**
         * Populates the expense category select dropdown with unique expense names
         * from all saved budgets.
         */
        function populateExpenseCategoriesSelect() {
            const categories = new Set();
            for (const monthKey in budgets) {
                budgets[monthKey].expenses.forEach(expense => {
                    if (expense.name) {
                        categories.add(expense.name);
                    }
                });
            }

            // Clear existing options, but keep the default "Select a category"
            expenseCategorySelect.innerHTML = '<option value="">-- Select a category --</option>';
            categories.forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category;
                expenseCategorySelect.appendChild(option);
            });

            // Set the selected value back if it existed, or default to empty
            const currentSelection = expenseCategorySelect.dataset.lastSelected || '';
            if (categories.has(currentSelection)) {
                expenseCategorySelect.value = currentSelection;
            } else {
                expenseCategorySelect.value = '';
            }
        }

        /**
         * Updates the individual expense history chart based on the selected category.
         * @param {string} selectedCategory - The name of the expense category to chart.
         */
        function updateIndividualExpenseChart(selectedCategory) {
            const monthLabels = [];
            const expenseValues = [];
            const isDarkMode = document.body.classList.contains('dark');

            // Sort months chronologically
            const sortedMonths = Object.keys(budgets).sort((a, b) => new Date(a) - new Date(b));

            sortedMonths.forEach(monthKey => {
                const monthData = budgets[monthKey];
                const [year, monthNum] = monthKey.split('-');
                const monthName = new Date(year, parseInt(monthNum) - 1).toLocaleString('default', { month: 'short' });
                monthLabels.push(`${monthName} ${year}`);

                let expenseAmount = 0;
                if (selectedCategory) {
                    const foundExpense = monthData.expenses.find(exp => exp.name === selectedCategory);
                    if (foundExpense) {
                        if (foundExpense.type === 'amount') {
                            expenseAmount = foundExpense.value;
                        } else if (foundExpense.type === 'percentage') {
                            expenseAmount = (monthData.income * (foundExpense.value / 100));
                        }
                    }
                }
                expenseValues.push(expenseAmount);
            });

            const chartData = {
                labels: monthLabels,
                datasets: [
                    {
                        label: selectedCategory ? `${selectedCategory} ($)` : 'No Category Selected',
                        data: expenseValues,
                        borderColor: selectedCategory ? 'rgb(54, 162, 235)' : 'rgb(150, 150, 150)', 
                        backgroundColor: selectedCategory ? 'rgba(54, 162, 235, 0.2)' : 'rgba(150, 150, 150, 0.1)',
                        tension: 0.1,
                        fill: true
                    }
                ]
            };

            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            color: isDarkMode ? '#e2e8f0' : '#4a5568'
                        }
                    },
                    title: {
                        display: true,
                        text: selectedCategory ? `Spending History for ${selectedCategory}` : 'Select an Expense Category to view history',
                        color: isDarkMode ? '#e2e8f0' : '#4a5568'
                    }
                },
                scales: {
                    x: {
                        ticks: {
                            color: isDarkMode ? '#cbd5e0' : '#4a5568'
                        },
                        grid: {
                            color: isDarkMode ? '#4a5568' : '#e2e8f0'
                        }
                    },
                    y: {
                        beginAtZero: true,
                        ticks: {
                            color: isDarkMode ? '#cbd5e0' : '#4a5568'
                        },
                        grid: {
                            color: isDarkMode ? '#4a5568' : '#e2e8f0'
                        }
                    }
                }
            };

            if (individualExpenseChart) {
                individualExpenseChart.destroy();
            }

            individualExpenseChart = new Chart(individualExpenseChartCanvas, {
                type: 'line',
                data: chartData,
                options: chartOptions
            });

            // Store current selection to restore after category list is repopulated
            expenseCategorySelect.dataset.lastSelected = selectedCategory;
        }

        // Event listener for expense category selection change
        expenseCategorySelect.addEventListener('change', (event) => {
            updateIndividualExpenseChart(event.target.value);
        });

        // Re-render chart on theme change to update colors
        themeToggle.addEventListener('click', () => {
            // Give a slight delay to allow CSS transition to apply to body
            setTimeout(() => {
                updateChart();
                updateIndividualExpenseChart(expenseCategorySelect.value);
            }, 100);
        });

        /**
         * Simple custom alert function to replace window.alert().
         * Displays a message temporarily on the screen.
         * @param {string} message - The message to display.
         * @param {string} type - 'success' or 'error' (optional, for styling).
         */
        function alertUser(message, type = 'success') {
            const alertBox = document.createElement('div');
            alertBox.textContent = message;
            alertBox.style.cssText = `
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                padding: 10px 20px;
                border-radius: 8px;
                color: white;
                font-weight: bold;
                z-index: 1000;
                opacity: 0;
                transition: opacity 0.5s ease-in-out;
            `;

            if (type === 'success') {
                alertBox.style.backgroundColor = '#4CAF50'; 
            } else if (type === 'error') {
                alertBox.style.backgroundColor = '#f44336'; 
            } else {
                alertBox.style.backgroundColor = '#333'; 
            }

            document.body.appendChild(alertBox);

            setTimeout(() => {
                alertBox.style.opacity = '1';
            }, 10); 

            setTimeout(() => {
                alertBox.style.opacity = '0';
                alertBox.addEventListener('transitionend', () => alertBox.remove());
            }, 3000); 
        }
    </script>
</body>
</html>
