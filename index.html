<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budgeting</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
        .container {
            max-width: 1024px;
            margin: 0 auto;
            padding: 1.5rem;
        }
        .card {
            background-color: #ffffff;
            border-radius: 0.75rem; /* Rounded corners */
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }
        /* Base input styling */
        input[type="number"], input[type="text"] {
            border: 1px solid #d1d5db; /* Light gray border */
            border-radius: 0.375rem; /* Slightly rounded */
            padding: 0.625rem 0.875rem;
            width: 100%;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }
        input[type="number"]:focus, input[type="text"]:focus {
            outline: none;
            border-color: #3b82f6; /* Blue focus border */
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.2);
        }
        /* General button styling, overridden by specific classes where needed */
        button {
            color: #ffffff;
            padding: 0.75rem 1.25rem;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        /* Specific styling for the Save Budget button */
        button[type="submit"] {
            background-color: #3b82f6; /* Blue background */
        }
        button[type="submit"]:hover {
            background-color: #2563eb; /* Darker blue on hover */
            box-shadow: 0 4px 8px rgba(59, 130, 246, 0.3);
        }
        .text-blue-600 {
            color: #2563eb;
        }
        .bg-blue-100 {
            background-color: #dbeafe;
        }
        /* Custom styling for the select dropdown for units (making it transparent and overlaid) */
        .expense-unit {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0; /* Make it invisible */
            cursor: pointer;
            appearance: none; /* Remove default dropdown arrow */
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            z-index: 10; /* Ensure it's above the visual elements */
        }

        /* Spinner animation */
        @keyframes spin {
            from {
                transform: rotate(0deg);
            }
            to {
                transform: rotate(360deg);
            }
        }
        .animate-spin-custom {
            animation: spin 1s linear infinite;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">
    <header class="bg-blue-600 text-white p-4 shadow-md">
        <div class="container flex justify-between items-center">
            <h1 class="text-2xl font-bold">Budget with Johnson</h1>
            <div id="user-info" class="text-sm">
                User ID: <span id="user-id" class="font-semibold">Loading...</span>
            </div>
        </div>
    </header>

    <main class="flex-grow container mt-6">
        <!-- Budget Input Section -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Monthly Budget Setup</h2>
            <form id="budget-form" class="space-y-4">
                <div>
                    <label for="income" class="block text-gray-700 text-sm font-medium mb-1">Monthly Income ($):</label>
                    <input type="number" id="income" step="0.01" min="0" placeholder="e.g., 3000" class="focus:ring-blue-500 focus:border-blue-500">
                </div>

                <div id="expense-inputs" class="space-y-3">
                    <label class="block text-gray-700 text-sm font-medium mb-1">Expense Categories:</label>
                    <!-- Initial expense input -->
                    <div class="flex items-center space-x-2 expense-item">
                        <input type="text" placeholder="Category Name" class="expense-category w-2/5">
                        <div class="flex items-center w-3/5 border border-gray-300 rounded-md focus-within:ring-2 focus-within:ring-blue-200 focus-within:border-blue-500">
                            <input type="number" step="0.01" min="0" placeholder="Amount" class="expense-amount flex-grow p-2 focus:outline-none border-none bg-transparent">

                            <!-- New wrapper for the custom unit display and hidden select -->
                            <div class="relative flex items-center bg-blue-200 border-l border-blue-300 rounded-r-md w-24">
                                <span class="expense-unit-display px-3 py-2 text-blue-800 font-medium"></span>
                                <div class="w-8 h-full flex items-center justify-center bg-blue-300 rounded-r-md border-l border-blue-400">
                                    <!-- SVG Arrow -->
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                    </svg>
                                </div>
                                <!-- Actual select element, positioned absolutely over the visual elements -->
                                <select class="expense-unit absolute inset-0 opacity-0 cursor-pointer">
                                    <option value="dollar">$</option>
                                    <option value="percent">%</option>
                                </select>
                            </div>
                        </div>
                        <button type="button" class="remove-expense-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                            </svg>
                        </button>
                    </div>
                </div>
                <button type="button" id="add-expense" class="bg-green-500 hover:bg-green-600 text-white w-full py-2 rounded-md font-medium flex items-center justify-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                    </svg>
                    <span>Add Expense Category</span>
                </button>
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700">Save Budget</button>
            </form>
        </div>

        <!-- Budget Summary Section -->
        <div class="card grid grid-cols-1 md:grid-cols-2 gap-6">
            <div>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Current Budget Overview</h2>
                <div class="space-y-2">
                    <p class="flex justify-between items-center text-gray-700">
                        <span class="font-medium">Total Income:</span>
                        <span id="display-income" class="font-bold text-lg text-blue-600">$0.00</span>
                    </p>
                    <p class="flex justify-between items-center text-gray-700">
                        <span class="font-medium">Total Allocated Expenses:</span>
                        <span id="display-allocated-expenses" class="font-bold text-lg text-red-500">$0.00</span>
                    </p>
                    <p class="flex justify-between items-center text-gray-700">
                        <span class="font-medium">Remaining Budget:</span>
                        <span id="display-remaining-budget" class="font-bold text-lg text-green-500">$0.00</span>
                    </p>
                </div>
                <div class="mt-4">
                    <h3 class="text-lg font-semibold mb-2 text-gray-800">Allocated Expenses:</h3>
                    <ul id="allocated-expenses-list" class="space-y-1 text-gray-600">
                        <!-- Allocated expenses will be listed here -->
                        <li class="text-center text-gray-500">No expenses allocated yet.</li>
                    </ul>
                </div>
            </div>
            <div>
                <h2 class="text-xl font-semibold mb-3 text-gray-800">Record Monthly Spending</h2>
                <form id="record-spending-form" class="space-y-4">
                    <div>
                        <label for="month-spent" class="block text-gray-700 text-sm font-medium mb-1">Month to Record Spending For:</label>
                        <input type="month" id="month-spent" class="focus:ring-blue-500 focus:border-blue-500">
                    </div>

                    <div id="actual-expense-inputs" class="space-y-3 hidden">
                        <label class="block text-gray-700 text-sm font-medium mb-1">Actual Spending by Category:</label>
                        <!-- Dynamic actual expense inputs will go here -->
                        <p class="text-center text-gray-500" id="no-categories-message">No categories loaded. Select a month or add manually.</p>
                    </div>
                    <button type="button" id="add-actual-expense" class="bg-gray-500 hover:bg-gray-600 text-white w-full py-2 rounded-md font-medium flex items-center justify-center space-x-2 hidden">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6" />
                        </svg>
                        <span>Add Actual Expense Category</span>
                    </button>
                    <button type="submit" class="w-full bg-purple-600 hover:bg-purple-700">Record Spending</button>
                </form>
            </div>
        </div>

        <!-- Category Spending History Section -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">Category Spending History</h2>
            <div class="flex items-center space-x-2 mb-4">
                <label for="category-filter" class="block text-gray-700 text-sm font-medium">Select Category:</label>
                <select id="category-filter" class="flex-grow p-2 rounded-md border border-gray-300 focus:ring-blue-500 focus:border-blue-500">
                    <option value="">All Categories</option>
                </select>
            </div>
            <ul id="category-spending-details" class="space-y-2 text-gray-600">
                <li class="text-center text-gray-500">Select a category to see its spending history.</li>
            </ul>
        </div>


        <!-- Spending History Chart Section -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800"><span id="chart-title-prefix">Total</span> Monthly Spending History</h2>
            <div class="relative h-96">
                <canvas id="spending-chart"></canvas>
            </div>
        </div>

        <!-- AI-Powered Budgeting Insights Section (Moved to bottom) -->
        <div class="card">
            <h2 class="text-xl font-semibold mb-4 text-gray-800">AI-Powered Budgeting Insights ✨</h2>
            <div class="mb-4">
                <button type="button" id="get-budget-tips-btn" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white py-2 rounded-md font-medium flex items-center justify-center space-x-2">
                    <span>Get Budgeting Tips ✨</span>
                </button>
            </div>

            <div id="loading-spinner" class="hidden flex justify-center items-center py-4">
                <div class="animate-spin-custom rounded-full h-12 w-12 border-4 border-t-4 border-blue-500 border-opacity-75"></div>
                <p class="ml-4 text-blue-700 font-medium">Generating tips...</p>
            </div>

            <div id="budget-tips-output" class="min-h-[100px] p-4 bg-gray-50 border border-gray-200 rounded-md text-gray-700 leading-relaxed whitespace-pre-wrap">
                Tips will appear here after clicking the button.
            </div>
            <p id="tips-error-message" class="text-red-600 mt-2 hidden">An error occurred while fetching tips. Please try again.</p>
        </div>
    </main>

    <footer class="bg-gray-800 text-white p-4 text-center text-sm mt-6">
        <p>&copy; 2024 Smart Budgeting App. All rights reserved.</p>
    </footer>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, query, onSnapshot, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Firebase configuration and initialization
        // __firebase_config is a global variable provided by the environment
        const firebaseConfig = JSON.parse(typeof __firebase_config !== 'undefined' ? __firebase_config : '{}');
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);

        let userId = null; // Store the user ID
        let allSpendingHistory = []; // Cache all spending history for category filtering

        // Function to safely get app ID
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Chart.js instance
        let spendingChart;

        // Function to initialize Chart.js
        const initChart = (labels = [], data = [], chartLabel = 'Total Actual Spending ($)') => {
            const ctx = document.getElementById('spending-chart').getContext('2d');
            if (spendingChart) {
                spendingChart.destroy(); // Destroy existing chart before creating a new one
            }
            spendingChart = new Chart(ctx, {
                type: 'line', // Line chart for history
                data: {
                    labels: labels,
                    datasets: [{
                        label: chartLabel, // Dynamic label
                        data: data,
                        borderColor: 'rgb(75, 192, 192)',
                        tension: 0.1,
                        fill: false, // Don't fill the area under the line
                        pointBackgroundColor: 'rgb(75, 192, 192)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'rgb(75, 192, 192)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false, // Allow chart to fill container
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top',
                        },
                        title: {
                            display: true,
                            text: chartLabel.replace(' ($)', '') + ' History' // Adjust title for clarity
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Amount ($)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Month'
                            }
                        }
                    }
                }
            });
        };

        // Initialize chart with empty data on load
        initChart();

        // --- Authentication and Data Initialization ---
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                // User is signed in.
                userId = user.uid;
                document.getElementById('user-id').textContent = userId;
                console.log("User signed in:", userId);

                // Load existing budget and spending data
                loadBudgetAndSpending();
                setupSpendingHistoryListener(); // Listener for total actual spending and category filter
            } else {
                // User is signed out.
                console.log("No user signed in. Attempting sign-in...");
                document.getElementById('user-id').textContent = 'Authenticating...';
                try {
                    // Use __initial_auth_token if available, otherwise sign in anonymously
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                    console.log("Authentication successful.");
                } catch (error) {
                    console.error("Authentication failed:", error);
                    document.getElementById('user-id').textContent = 'Failed to authenticate.';
                }
            }
        });

        // --- Firestore Data Operations ---

        // Function to load existing budget data (for current setup)
        const loadBudgetAndSpending = async () => {
            if (!userId) {
                console.warn("User ID not available yet for loading data.");
                return;
            }
            try {
                // Get current budget document
                const budgetRef = doc(db, `/artifacts/${appId}/users/${userId}/currentBudget`, 'currentBudget');
                const budgetSnap = await getDoc(budgetRef);

                if (budgetSnap.exists()) {
                    const data = budgetSnap.data();
                    document.getElementById('income').value = data.income || '';
                    displayBudgetSummary(data.income || 0, data.expenses || {});

                    // Dynamically populate expense inputs for the setup form
                    const expenseInputsDiv = document.getElementById('expense-inputs');
                    expenseInputsDiv.innerHTML = '<label class="block text-gray-700 text-sm font-medium mb-1">Expense Categories:</label>'; // Clear existing
                    const expenseEntries = Object.entries(data.expenses || {});
                    if (expenseEntries.length > 0) {
                        expenseEntries.forEach(([category, amount]) => {
                            // Assuming all loaded amounts are in dollars for display
                            addExpenseInput(category, amount, 'dollar');
                        });
                    } else {
                        addExpenseInput('', 0, 'dollar'); // Add one empty expense input if none exist
                    }
                } else {
                    console.log("No current budget found for this user.");
                    displayBudgetSummary(0, {}); // Clear display if no budget
                    // Ensure at least one empty expense input is present if no budget exists
                    const expenseInputsDiv = document.getElementById('expense-inputs');
                    expenseInputsDiv.innerHTML = '<label class="block text-gray-700 text-sm font-medium mb-1">Expense Categories:</label>';
                    addExpenseInput('', 0, 'dollar');
                }
            } catch (error) {
                console.error("Error loading budget data:", error);
            }
        };


        // Function to save current budget setup
        const saveBudget = async (income, expenses) => {
            if (!userId) {
                console.error("Cannot save budget: User ID not available.");
                return;
            }
            try {
                const budgetRef = doc(db, `/artifacts/${appId}/users/${userId}/currentBudget`, 'currentBudget');
                await setDoc(budgetRef, {
                    income: income,
                    expenses: expenses,
                    timestamp: serverTimestamp() // Add a timestamp
                }, { merge: true }); // Use merge to avoid overwriting other fields if they exist
                console.log("Current budget setup saved successfully!");
                displayBudgetSummary(income, expenses); // Update display
            } catch (error) {
                console.error("Error saving current budget:", error);
                // Optionally display an error message to the user
            }
        };

        // Function to record monthly spending and save budget snapshot
        const recordSpending = async (month, actualExpenses) => {
            if (!userId) {
                console.error("Cannot record spending: User ID not available.");
                return;
            }
            try {
                // 1. Save the current allocated budget as a historical snapshot for this month
                const currentIncome = parseFloat(document.getElementById('income').value) || 0;
                const currentAllocatedExpenses = {};
                document.querySelectorAll('#expense-inputs .expense-item').forEach((expenseItemDiv) => {
                    const categoryInput = expenseItemDiv.querySelector('.expense-category');
                    const amountInput = expenseItemDiv.querySelector('.expense-amount');
                    const unitSelect = expenseItemDiv.querySelector('.expense-unit');

                    const categoryName = categoryInput.value.trim();
                    let amount = parseFloat(amountInput.value) || 0;
                    const unit = unitSelect.value;

                    if (categoryName) {
                        if (unit === 'percent') {
                            amount = (currentIncome * amount) / 100;
                        }
                        currentAllocatedExpenses[categoryName] = amount;
                    }
                });

                const historicalBudgetRef = doc(db, `/artifacts/${appId}/users/${userId}/historicalBudgets`, month);
                await setDoc(historicalBudgetRef, {
                    income: currentIncome,
                    expenses: currentAllocatedExpenses,
                    timestamp: serverTimestamp()
                }, { merge: true });
                console.log("Historical allocated budget saved successfully for", month);


                // 2. Save the actual spending for this month
                const spendingHistoryRef = doc(db, `/artifacts/${appId}/users/${userId}/spendingHistory`, month);
                await setDoc(spendingHistoryRef, {
                    month: month,
                    actualExpenses: actualExpenses,
                    timestamp: serverTimestamp()
                }, { merge: true });
                console.log("Actual spending recorded successfully for", month);

                // 3. Reset the current budget input fields and summary display
                document.getElementById('income').value = ''; // Clear income
                const expenseInputsDiv = document.getElementById('expense-inputs');
                expenseInputsDiv.innerHTML = '<label class="block text-gray-700 text-sm font-medium mb-1">Expense Categories:</label>';
                addExpenseInput('', 0, 'dollar'); // Add one empty expense input
                displayBudgetSummary(0, {}); // Reset summary display

                // Clear record spending form and hide actual expense inputs
                document.getElementById('month-spent').value = '';
                document.getElementById('actual-expense-inputs').innerHTML = '<label class="block text-gray-700 text-sm font-medium mb-1">Actual Spending by Category:</label><p class="text-center text-gray-500" id="no-categories-message">Select a month to load categories or add manually.</p>';
                document.getElementById('actual-expense-inputs').classList.add('hidden');
                document.getElementById('add-actual-expense').classList.add('hidden');

            } catch (error) {
                console.error("Error recording spending and saving historical budget:", error);
                // Optionally display an error message to the user
            }
        };

        // Function to set up real-time listener for spending history
        const setupSpendingHistoryListener = () => {
            if (!userId) {
                console.warn("User ID not available yet for setting up spending listener.");
                return;
            }
            const spendingCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/spendingHistory`);
            const historicalBudgetsCollectionRef = collection(db, `/artifacts/${appId}/users/${userId}/historicalBudgets`);

            // Listen to spending history
            onSnapshot(spendingCollectionRef, (snapshot) => {
                allSpendingHistory = [];
                let uniqueCategories = new Set();
                snapshot.forEach((doc) => {
                    const data = doc.data();
                    allSpendingHistory.push(data);
                    if (data.actualExpenses) {
                        Object.keys(data.actualExpenses).forEach(cat => uniqueCategories.add(cat));
                    }
                });

                // Sort data by month (string format 'YYYY-MM') for chronological order
                allSpendingHistory.sort((a, b) => {
                    if (a.month < b.month) return -1;
                    if (a.month > b.month) return 1;
                    return 0;
                });

                // Update total monthly spending chart initially
                updateTotalSpendingChart();


                // Populate category filter dropdown
                const categoryFilterSelect = document.getElementById('category-filter');
                categoryFilterSelect.innerHTML = '<option value="">All Categories</option>'; // Reset
                uniqueCategories.forEach(category => {
                    const option = document.createElement('option');
                    option.value = category;
                    option.textContent = category;
                    categoryFilterSelect.appendChild(option);
                });

                // If a category is already selected, re-display its history
                if (categoryFilterSelect.value) {
                    displayCategorySpendingHistory(categoryFilterSelect.value);
                } else {
                    document.getElementById('category-spending-details').innerHTML = '<li class="text-center text-gray-500">Select a category to see its spending history.</li>';
                }

            }, (error) => {
                console.error("Error fetching spending history for chart:", error);
            });

            // Listen to historical budgets to populate category filter with allocated categories too
            onSnapshot(historicalBudgetsCollectionRef, (snapshot) => {
                const categoryFilterSelect = document.getElementById('category-filter');
                let existingCategories = new Set(Array.from(categoryFilterSelect.options).map(opt => opt.value).filter(val => val !== ""));

                snapshot.forEach((doc) => {
                    const data = doc.data();
                    if (data.expenses) {
                        Object.keys(data.expenses).forEach(cat => {
                            if (!existingCategories.has(cat)) {
                                existingCategories.add(cat);
                                const option = document.createElement('option');
                                option.value = cat;
                                option.textContent = cat;
                                categoryFilterSelect.appendChild(option);
                            }
                        });
                    }
                });
            }, (error) => {
                console.error("Error fetching historical budgets for category filter:", error);
            });
        };

        // Function to update the chart with total spending
        const updateTotalSpendingChart = () => {
            const labels = allSpendingHistory.map(d => d.month);
            const data = allSpendingHistory.map(d => {
                let totalMonthSpending = 0;
                if (d.actualExpenses) {
                    for (const category in d.actualExpenses) {
                        totalMonthSpending += parseFloat(d.actualExpenses[category]);
                    }
                }
                return totalMonthSpending;
            });
            document.getElementById('chart-title-prefix').textContent = 'Total';
            initChart(labels, data, 'Total Actual Spending ($)');
        };


        // --- UI Update Functions ---

        const displayBudgetSummary = (income, expenses) => {
            document.getElementById('display-income').textContent = `$${income.toFixed(2)}`;

            let totalAllocated = 0;
            const allocatedExpensesList = document.getElementById('allocated-expenses-list');
            allocatedExpensesList.innerHTML = ''; // Clear previous list

            const expenseEntries = Object.entries(expenses);
            if (expenseEntries.length === 0) {
                allocatedExpensesList.innerHTML = '<li class="text-center text-gray-500">No expenses allocated yet.</li>';
            } else {
                expenseEntries.forEach(([category, amount]) => {
                    totalAllocated += parseFloat(amount);
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-blue-50 p-2 rounded-md';
                    li.innerHTML = `
                        <span>${category}:</span>
                        <span class="font-medium">$${parseFloat(amount).toFixed(2)}</span>
                    `;
                    allocatedExpensesList.appendChild(li);
                });
            }

            document.getElementById('display-allocated-expenses').textContent = `$${totalAllocated.toFixed(2)}`;
            const remaining = income - totalAllocated;
            document.getElementById('display-remaining-budget').textContent = `$${remaining.toFixed(2)}`;
            document.getElementById('display-remaining-budget').className = `font-bold text-lg ${remaining >= 0 ? 'text-green-500' : 'text-red-500'}`;
        };

        // Function to add a new expense input row for Budget Setup
        const addExpenseInput = (category = '', amount = '', unit = 'dollar') => {
            const expenseInputsDiv = document.getElementById('expense-inputs');
            const newExpenseDiv = document.createElement('div');
            newExpenseDiv.className = 'flex items-center space-x-2 expense-item';
            newExpenseDiv.innerHTML = `
                <input type="text" placeholder="Category Name" class="expense-category w-2/5" value="${category}">
                <div class="flex items-center w-3/5 border border-gray-300 rounded-md focus-within:ring-2 focus-within:ring-blue-200 focus-within:border-blue-500">
                    <input type="number" step="0.01" min="0" placeholder="Amount" class="expense-amount flex-grow p-2 focus:outline-none border-none bg-transparent" value="${amount}">

                    <!-- New wrapper for the custom unit display and hidden select -->
                    <div class="relative flex items-center bg-blue-200 border-l border-blue-300 rounded-r-md w-24">
                        <span class="expense-unit-display px-3 py-2 text-blue-800 font-medium"></span>
                        <div class="w-8 h-full flex items-center justify-center bg-blue-300 rounded-r-md border-l border-blue-400">
                            <!-- SVG Arrow -->
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-blue-700" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                        <!-- Actual select element, positioned absolutely over the visual elements -->
                        <select class="expense-unit absolute inset-0 opacity-0 cursor-pointer">
                            <option value="dollar">$</option>
                            <option value="percent">%</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="remove-expense-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                </button>
            `;
            expenseInputsDiv.appendChild(newExpenseDiv);

            const selectElement = newExpenseDiv.querySelector('.expense-unit');
            const displaySpan = newExpenseDiv.querySelector('.expense-unit-display');

            // Set initial selected option and display text
            selectElement.value = unit;
            displaySpan.textContent = unit === 'dollar' ? '$' : '%';

            // Add event listener for change on the transparent select
            selectElement.addEventListener('change', () => {
                displaySpan.textContent = selectElement.value === 'dollar' ? '$' : '%';
            });

            // Add event listener to the new remove button
            newExpenseDiv.querySelector('.remove-expense-btn').addEventListener('click', (event) => {
                event.target.closest('.expense-item').remove();
            });
        };

        // Function to add a new actual expense input row for Record Spending form
        const addActualExpenseInput = (category = '', amount = '') => {
            const actualExpenseInputsDiv = document.getElementById('actual-expense-inputs');
            // Remove "no categories message" if present
            const noCategoriesMessage = document.getElementById('no-categories-message');
            if (noCategoriesMessage) {
                noCategoriesMessage.remove();
            }

            const newActualExpenseDiv = document.createElement('div');
            newActualExpenseDiv.className = 'flex items-center space-x-2 actual-expense-item';
            newActualExpenseDiv.innerHTML = `
                <input type="text" placeholder="Category Name" class="actual-expense-category w-2/5" value="${category}">
                <input type="number" step="0.01" min="0" placeholder="Actual Amount ($)" class="actual-expense-amount flex-grow p-2 focus:outline-none border border-gray-300 rounded-md" value="${amount}">
                <button type="button" class="remove-actual-expense-btn bg-red-500 hover:bg-red-600 text-white p-2 rounded-full w-8 h-8 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20 12H4" />
                    </svg>
                </button>
            `;
            actualExpenseInputsDiv.appendChild(newActualExpenseDiv);

            // Add event listener to the new remove button
            newActualExpenseDiv.querySelector('.remove-actual-expense-btn').addEventListener('click', (event) => {
                event.target.closest('.actual-expense-item').remove();
                // Re-add "no categories message" if all inputs are removed and month is selected
                if (actualExpenseInputsDiv.querySelectorAll('.actual-expense-item').length === 0 && document.getElementById('month-spent').value) {
                     actualExpenseInputsDiv.innerHTML += '<p class="text-center text-gray-500" id="no-categories-message">No categories found for this month. Add manually.</p>';
                } else if (actualExpenseInputsDiv.querySelectorAll('.actual-expense-item').length === 0 && !document.getElementById('month-spent').value) {
                     actualExpenseInputsDiv.innerHTML += '<p class="text-center text-gray-500" id="no-categories-message">Select a month to load categories or add manually.</p>';
                }
            });
        };

        // Function to display spending history for a selected category AND update the chart
        const displayCategorySpendingHistory = (selectedCategory) => {
            const categorySpendingDetailsList = document.getElementById('category-spending-details');
            categorySpendingDetailsList.innerHTML = ''; // Clear previous list

            const chartTitlePrefix = document.getElementById('chart-title-prefix');

            if (!selectedCategory || selectedCategory === "") {
                categorySpendingDetailsList.innerHTML = '<li class="text-center text-gray-500">Select a category to see its spending history.</li>';
                updateTotalSpendingChart(); // Go back to total spending chart
                return;
            }

            const filteredData = allSpendingHistory.filter(record =>
                record.actualExpenses && record.actualExpenses.hasOwnProperty(selectedCategory)
            );

            if (filteredData.length === 0) {
                categorySpendingDetailsList.innerHTML = `<li class="text-center text-gray-500">No spending recorded for "${selectedCategory}".</li>`;
                // If no data for category, show an empty chart for that category
                chartTitlePrefix.textContent = selectedCategory;
                initChart([], [], `${selectedCategory} Spending ($)`);
            } else {
                filteredData.forEach(record => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center bg-gray-50 p-2 rounded-md';
                    li.innerHTML = `
                        <span>${record.month}:</span>
                        <span class="font-medium text-purple-600">$${parseFloat(record.actualExpenses[selectedCategory]).toFixed(2)}</span>
                    `;
                    categorySpendingDetailsList.appendChild(li);
                });

                // Update the chart for the selected category
                const labels = filteredData.map(d => d.month);
                const data = filteredData.map(d => parseFloat(d.actualExpenses[selectedCategory]));
                chartTitlePrefix.textContent = selectedCategory;
                initChart(labels, data, `${selectedCategory} Spending ($)`);
            }
        };


        // --- Event Listeners ---

        // Add expense category dynamically for Budget Setup
        document.getElementById('add-expense').addEventListener('click', () => {
            addExpenseInput();
        });

        // Event delegation for initial remove buttons in Budget Setup
        document.getElementById('expense-inputs').addEventListener('click', (event) => {
            if (event.target.closest('.remove-expense-btn')) {
                event.target.closest('.expense-item').remove();
            }
        });

        // Handle budget form submission (Save Current Budget)
        document.getElementById('budget-form').addEventListener('submit', (event) => {
            event.preventDefault();
            const income = parseFloat(document.getElementById('income').value) || 0;
            const expenses = {};
            document.querySelectorAll('#expense-inputs .expense-item').forEach((expenseItemDiv) => {
                const categoryInput = expenseItemDiv.querySelector('.expense-category');
                const amountInput = expenseItemDiv.querySelector('.expense-amount');
                const unitSelect = expenseItemDiv.querySelector('.expense-unit');

                const categoryName = categoryInput.value.trim();
                let amount = parseFloat(amountInput.value) || 0;
                const unit = unitSelect.value;

                if (categoryName) { // Allow 0 amount, but not empty category name
                    if (unit === 'percent') {
                        // Calculate dollar amount if unit is percentage
                        amount = (income * amount) / 100;
                    }
                    expenses[categoryName] = amount;
                }
            });

            saveBudget(income, expenses);
        });

        // Event listener for month-spent input to load categories
        document.getElementById('month-spent').addEventListener('change', async (event) => {
            const selectedMonth = event.target.value;
            const actualExpenseInputsDiv = document.getElementById('actual-expense-inputs');
            const addActualExpenseButton = document.getElementById('add-actual-expense');

            actualExpenseInputsDiv.innerHTML = '<label class="block text-gray-700 text-sm font-medium mb-1">Actual Spending by Category:</label>'; // Clear previous inputs

            if (!userId) {
                actualExpenseInputsDiv.innerHTML += '<p class="text-center text-gray-500">Please sign in to load categories.</p>';
                actualExpenseInputsDiv.classList.add('hidden');
                addActualExpenseButton.classList.add('hidden');
                return;
            }

            if (selectedMonth) {
                // Show the actual expense input section
                actualExpenseInputsDiv.classList.remove('hidden');
                actualExpenseInputsDiv.classList.add('flex-col'); // Add flex-col for proper spacing
                addActualExpenseButton.classList.remove('hidden');

                const currentIncome = parseFloat(document.getElementById('income').value) || 0;
                let categoriesAndAmountsToLoad = {};

                // 1. Get currently allocated expenses from the "Monthly Budget Setup" section
                document.querySelectorAll('#expense-inputs .expense-item').forEach((expenseItemDiv) => {
                    const categoryInput = expenseItemDiv.querySelector('.expense-category');
                    const amountInput = expenseItemDiv.querySelector('.expense-amount');
                    const unitSelect = expenseItemDiv.querySelector('.expense-unit');

                    const categoryName = categoryInput.value.trim();
                    let amount = parseFloat(amountInput.value) || 0;
                    const unit = unitSelect.value;

                    if (categoryName) {
                        if (unit === 'percent') {
                            amount = (currentIncome * amount) / 100;
                        }
                        categoriesAndAmountsToLoad[categoryName] = amount;
                    }
                });

                // 2. Load historical allocated budget for the selected month (overrides current setup if it exists)
                const historicalBudgetRef = doc(db, `/artifacts/${appId}/users/${userId}/historicalBudgets`, selectedMonth);
                const historicalBudgetSnap = await getDoc(historicalBudgetRef);
                if (historicalBudgetSnap.exists()) {
                    Object.assign(categoriesAndAmountsToLoad, historicalBudgetSnap.data().expenses || {});
                }

                // 3. Load previously recorded actual spending for the selected month (overrides both allocated if it exists)
                const recordedSpendingRef = doc(db, `/artifacts/${appId}/users/${userId}/spendingHistory`, selectedMonth);
                const recordedSpendingSnap = await getDoc(recordedSpendingRef);
                if (recordedSpendingSnap.exists()) {
                    Object.assign(categoriesAndAmountsToLoad, recordedSpendingSnap.data().actualExpenses || {});
                }

                // Populate actual expense inputs based on the combined data
                if (Object.keys(categoriesAndAmountsToLoad).length > 0) {
                    for (const category in categoriesAndAmountsToLoad) {
                        const amount = categoriesAndAmountsToLoad[category];
                        addActualExpenseInput(category, amount);
                    }
                } else {
                    actualExpenseInputsDiv.innerHTML += '<p class="text-center text-gray-500" id="no-categories-message">No categories found for this month. Add manually.</p>';
                }

            } else {
                 actualExpenseInputsDiv.innerHTML += '<p class="text-center text-gray-500" id="no-categories-message">Select a month to load categories or add manually.</p>';
                 actualExpenseInputsDiv.classList.add('hidden');
                 actualExpenseInputsDiv.classList.remove('flex-col'); // Remove flex-col if hidden
                 addActualExpenseButton.classList.add('hidden');
            }
        });

        // Add actual expense category dynamically
        document.getElementById('add-actual-expense').addEventListener('click', () => {
            addActualExpenseInput();
        });

        // Event delegation for remove buttons in Actual Spending
        document.getElementById('actual-expense-inputs').addEventListener('click', (event) => {
            if (event.target.closest('.remove-actual-expense-btn')) {
                event.target.closest('.actual-expense-item').remove();
                if (document.getElementById('actual-expense-inputs').querySelectorAll('.actual-expense-item').length === 0) {
                    const selectedMonth = document.getElementById('month-spent').value;
                    document.getElementById('actual-expense-inputs').innerHTML += `<p class="text-center text-gray-500" id="no-categories-message">${selectedMonth ? 'No categories found for this month. Add manually.' : 'Select a month to load categories or add manually.'}</p>`;
                }
            }
        });


        // Handle record spending form submission
        document.getElementById('record-spending-form').addEventListener('submit', (event) => {
            event.preventDefault();
            const month = document.getElementById('month-spent').value;
            const actualExpenses = {};

            if (!month) {
                console.warn("Please select a month to record spending.");
                // In a real app, you might show a user-friendly message
                return;
            }

            document.querySelectorAll('#actual-expense-inputs .actual-expense-item').forEach((expenseItemDiv) => {
                const categoryInput = expenseItemDiv.querySelector('.actual-expense-category');
                const amountInput = expenseItemDiv.querySelector('.actual-expense-amount');

                const categoryName = categoryInput.value.trim();
                const amount = parseFloat(amountInput.value) || 0;

                if (categoryName) { // Allow 0 amount, but not empty category name
                    actualExpenses[categoryName] = amount;
                }
            });

            if (Object.keys(actualExpenses).length > 0) {
                recordSpending(month, actualExpenses);
            } else {
                console.warn("Please enter at least one actual spending amount.");
                // Show user message
            }
        });

        // Event listener for category filter dropdown
        document.getElementById('category-filter').addEventListener('change', (event) => {
            const selectedCategory = event.target.value;
            displayCategorySpendingHistory(selectedCategory);
        });

        // --- Gemini API Integration ---
        document.getElementById('get-budget-tips-btn').addEventListener('click', callGeminiAPIForBudgetTips);

        async function callGeminiAPIForBudgetTips() {
            const tipsOutputDiv = document.getElementById('budget-tips-output');
            const loadingSpinner = document.getElementById('loading-spinner');
            const errorMessage = document.getElementById('tips-error-message');

            tipsOutputDiv.textContent = ''; // Clear previous tips
            tipsOutputDiv.classList.add('hidden'); // Hide tips area initially
            errorMessage.classList.add('hidden'); // Hide error message
            loadingSpinner.classList.remove('hidden'); // Show loading spinner

            try {
                // Get current income
                const income = parseFloat(document.getElementById('income').value) || 0;

                // Get current allocated expenses
                const expenses = {};
                document.querySelectorAll('#expense-inputs .expense-item').forEach((expenseItemDiv) => {
                    const categoryInput = expenseItemDiv.querySelector('.expense-category');
                    const amountInput = expenseItemDiv.querySelector('.expense-amount');
                    const unitSelect = expenseItemDiv.querySelector('.expense-unit');

                    const categoryName = categoryInput.value.trim();
                    let amount = parseFloat(amountInput.value) || 0;
                    const unit = unitSelect.value;

                    if (categoryName) {
                        if (unit === 'percent') {
                            amount = (income * amount) / 100;
                        }
                        expenses[categoryName] = amount;
                    }
                });

                let prompt = `I have a monthly income of $${income.toFixed(2)}.`;
                if (Object.keys(expenses).length > 0) {
                    prompt += ` My allocated expenses are: ${JSON.stringify(expenses)}.`;
                } else {
                    prompt += ` I haven't allocated any specific expenses yet.`;
                }
                prompt += ` Please provide 3-5 actionable budgeting tips to help me save money or optimize my spending, specifically considering these allocations. Focus on practical advice and avoid generic statements.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });
                const payload = { contents: chatHistory };
                const apiKey = ""; // If you want to use models other than gemini-2.0-flash or imagen-3.0-generate-002, provide an API key here. Otherwise, leave this as-is.
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const text = result.candidates[0].content.parts[0].text;
                    tipsOutputDiv.textContent = text;
                    tipsOutputDiv.classList.remove('hidden');
                } else {
                    errorMessage.textContent = 'Could not generate tips. Unexpected API response structure.';
                    errorMessage.classList.remove('hidden');
                    console.error("Unexpected API response structure:", result);
                }

            } catch (error) {
                errorMessage.textContent = 'Failed to connect to the budgeting insights service. Please check your internet connection or try again later.';
                errorMessage.classList.remove('hidden');
                console.error("Error calling Gemini API:", error);
            } finally {
                loadingSpinner.classList.add('hidden'); // Hide loading spinner
            }
        }
    </script>
</body>
</html>
