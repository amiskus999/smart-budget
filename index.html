<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Budget Planner</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        /* Light mode default styles */
        body {
            background-color: #f3f4f6; /* Light gray background */
            color: #1f2937; /* Dark text */
        }
        .dark body {
            background-color: #1a202c; /* Dark background */
            color: #e2e8f0; /* Light text */
        }
        .card {
            background-color: #ffffff; /* White card background */
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        .dark .card {
            background-color: #2d3748; /* Darker card background */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
        }
        input[type="number"], input[type="text"], select {
            background-color: #edf2f7; /* Light input background */
            border: 1px solid #cbd5e0;
        }
        .dark input[type="number"], .dark input[type="text"], .dark select {
            background-color: #4a5568; /* Dark input background */
            border: 1px solid #2d3748;
            color: #e2e8f0;
        }
        button {
            transition: background-color 0.2s ease;
        }
        button:hover {
            opacity: 0.9;
        }
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }
        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 34px;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            -webkit-transition: .4s;
            transition: .4s;
            border-radius: 50%;
        }
        input:checked + .slider {
            background-color: #2196F3;
        }
        input:focus + .slider {
            box-shadow: 0 0 1px #2196F3;
        }
        input:checked + .slider:before {
            -webkit-transform: translateX(26px);
            -ms-transform: translateX(26px);
            transform: translateX(26px);
        }
        /* Style for the remove button symbol */
        .remove-btn-symbol {
            font-weight: bold; /* Make the 'x' bolder */
            font-size: 1.25rem; /* Adjust size if needed */
            line-height: 1; /* Align vertically */
            padding: 0.5rem 0.75rem; /* Smaller padding for a compact button */
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center py-8 px-4">

    <!-- Header -->
    <header class="w-full max-w-4xl flex justify-between items-center mb-8">
        <h1 class="text-4xl font-bold text-blue-600 dark:text-blue-400">Smart Budget Planner</h1>
        <div class="flex items-center space-x-2">
            <span class="text-gray-700 dark:text-gray-300">Light</span>
            <label class="toggle-switch">
                <input type="checkbox" id="darkModeToggle">
                <span class="slider"></span>
            </label>
            <span class="text-gray-700 dark:text-gray-300">Dark</span>
        </div>
    </header>

    <!-- Main Content Area -->
    <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-2 gap-8">

        <!-- Current Month Budgeting -->
        <section class="card p-6 md:p-8 space-y-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Budget for <span id="currentMonthDisplay"></span></h2>

            <!-- Month and Year Select -->
            <div class="flex flex-col sm:flex-row gap-4">
                <div class="flex-1">
                    <label for="monthSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Month:</label>
                    <select id="monthSelect" class="w-full p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
                <div class="flex-1">
                    <label for="yearSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Year:</label>
                    <select id="yearSelect" class="w-full p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
                </div>
            </div>

            <!-- Income Input -->
            <div>
                <label for="incomeInput" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">Monthly Income:</label>
                <input type="number" id="incomeInput" placeholder="Enter income" class="w-full p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>

            <!-- Expense Categories -->
            <div id="expensesContainer" class="space-y-4">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Expenses:</h3>
                <!-- Dynamic expense inputs will be added here by JS -->
            </div>
            <button id="addExpenseBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Add Expense</button>

            <!-- Budget Summary -->
            <div class="border-t pt-4 mt-4 border-gray-200 dark:border-gray-600">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Summary:</h3>
                <p class="text-gray-700 dark:text-gray-300">Total Expenses: <span id="totalExpenses" class="font-medium">$0.00</span></p>
                <p class="text-gray-700 dark:text-gray-300">Remaining Balance: <span id="remainingBalance" class="font-medium">$0.00</span></p>
            </div>

            <button id="saveBudgetBtn" class="w-full bg-green-500 text-white py-3 px-4 rounded-md text-lg font-semibold hover:bg-green-600 focus:outline-none focus:ring-2 focus:ring-green-500">Save Monthly Budget</button>
        </section>

        <!-- Spending History & Previous Months -->
        <section class="card p-6 md:p-8 space-y-6">
            <h2 class="text-2xl font-semibold mb-4 text-gray-800 dark:text-gray-200">Spending History</h2>

            <!-- Chart Canvas -->
            <div class="bg-gray-100 dark:bg-gray-700 p-4 rounded-md">
                <canvas id="spendingChart"></canvas>
            </div>

            <!-- Select Month for Details/Edit -->
            <div>
                <label for="historyMonthSelect" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-1">View/Edit Previous Month:</label>
                <select id="historyMonthSelect" class="w-full p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"></select>
            </div>

            <!-- Selected Month Details/Edit Area -->
            <div id="selectedMonthDetails" class="space-y-4 border-t pt-4 mt-4 border-gray-200 dark:border-gray-600 hidden">
                <h3 class="text-xl font-semibold text-gray-800 dark:text-gray-200">Details for <span id="detailsMonthDisplay"></span>:</h3>
                <p class="text-gray-700 dark:text-gray-300">Income: <span id="detailsIncome" class="font-medium">$0.00</span></p>
                <h4 class="text-lg font-semibold text-gray-800 dark:text-gray-200">Expenses:</h4>
                <div id="detailsExpensesContainer" class="space-y-3">
                    <!-- Expenses for selected month will be loaded here -->
                </div>
                <button id="addHistoryExpenseBtn" class="w-full bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600 focus:outline-none focus:ring-2 focus:ring-blue-500">Add New Expense for this Month</button>
                <button id="saveHistoryBudgetBtn" class="w-full bg-purple-500 text-white py-3 px-4 rounded-md text-lg font-semibold hover:bg-purple-600 focus:outline-none focus:ring-2 focus:ring-purple-500">Save Changes for this Month</button>
            </div>
        </section>
    </main>

    <script>
        // Global variables for Chart.js instance
        let spendingChart = null;

        // Function to get the currently selected month and year from the dropdowns
        function getSelectedMonthKey() {
            const year = document.getElementById('yearSelect').value;
            const month = document.getElementById('monthSelect').value;
            if (year && month) {
                return `${year}-${month}`;
            }
            return ''; // Return empty if not fully selected
        }

        // Function to display current month
        function displayCurrentMonthName() {
            const year = document.getElementById('yearSelect').value;
            const monthNum = parseInt(document.getElementById('monthSelect').value);
            if (year && !isNaN(monthNum)) {
                const date = new Date(year, monthNum - 1, 1);
                const options = { year: 'numeric', month: 'long' };
                document.getElementById('currentMonthDisplay').textContent = date.toLocaleDateString('en-US', options);
            } else {
                document.getElementById('currentMonthDisplay').textContent = 'Select Month';
            }
        }

        // Function to load budgets from local storage
        function loadBudgets() {
            const budgetsJSON = localStorage.getItem('budgets');
            return budgetsJSON ? JSON.parse(budgetsJSON) : {};
        }

        // Function to save budgets to local storage
        function saveBudgets(budgets) {
            localStorage.setItem('budgets', JSON.stringify(budgets));
        }

        // Initialize budgets data
        let budgets = loadBudgets();

        // Helper function to format currency
        function formatCurrency(amount) {
            return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);
        }

        // --- Dark Mode Logic ---
        const darkModeToggle = document.getElementById('darkModeToggle');
        function enableDarkMode() {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            updateChartTheme(); // Update chart colors
        }
        function disableDarkMode() {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            updateChartTheme(); // Update chart colors
        }

        // Check for saved theme preference or system preference
        const prefersDarkMode = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
        const savedTheme = localStorage.getItem('theme');

        if (savedTheme === 'dark' || (!savedTheme && prefersDarkMode)) {
            enableDarkMode();
            darkModeToggle.checked = true;
        } else {
            disableDarkMode();
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                enableDarkMode();
            } else {
                disableDarkMode();
            }
        });

        // --- Current Month Budgeting Logic ---
        const monthSelect = document.getElementById('monthSelect');
        const yearSelect = document.getElementById('yearSelect');
        const incomeInput = document.getElementById('incomeInput');
        const expensesContainer = document.getElementById('expensesContainer');
        const addExpenseBtn = document.getElementById('addExpenseBtn');
        const saveBudgetBtn = document.getElementById('saveBudgetBtn');
        const totalExpensesSpan = document.getElementById('totalExpenses');
        const remainingBalanceSpan = document.getElementById('remainingBalance');

        // Stores expense input elements for current month dynamically
        let currentMonthExpenses = [];

        function populateMonthYearDropdowns() {
            const now = new Date();
            const currentMonth = now.getMonth() + 1; // 1-indexed
            const currentYear = now.getFullYear();

            // Populate months
            monthSelect.innerHTML = '';
            for (let i = 0; i < 12; i++) {
                const monthDate = new Date(currentYear, i, 1);
                const option = document.createElement('option');
                option.value = (i + 1).toString().padStart(2, '0');
                option.textContent = monthDate.toLocaleDateString('en-US', { month: 'long' });
                monthSelect.appendChild(option);
            }
            monthSelect.value = currentMonth.toString().padStart(2, '0'); // Set default to current month

            // Populate years (e.g., current year +/- 5 years)
            yearSelect.innerHTML = '';
            for (let i = currentYear - 5; i <= currentYear + 5; i++) {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                yearSelect.appendChild(option);
            }
            yearSelect.value = currentYear; // Set default to current year

            // Add event listeners to update budget when month/year changes
            monthSelect.addEventListener('change', loadCurrentMonthBudget);
            yearSelect.addEventListener('change', loadCurrentMonthBudget);
        }


        function addExpenseInput(expense = { name: '', amount: '', type: 'value' }, isInitialLoad = false) {
            const expenseDiv = document.createElement('div');
            expenseDiv.className = 'flex flex-col sm:flex-row gap-2 items-end sm:items-center';

            const expenseIndex = currentMonthExpenses.length;
            currentMonthExpenses.push(expenseDiv); // Add to tracking array

            expenseDiv.innerHTML = `
                <input type="text" placeholder="Expense Name" value="${expense.name}" class="expense-name flex-1 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <input type="number" placeholder="Amount" value="${expense.amount}" step="0.01" class="expense-amount w-24 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                <select class="expense-type p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="value" ${expense.type === 'value' ? 'selected' : ''}>$</option>
                    <option value="percentage" ${expense.type === 'percentage' ? 'selected' : ''}>%</option>
                </select>
                <button class="remove-expense-btn bg-red-500 text-white p-2 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 remove-btn-symbol">&times;</button>
            `;
            expensesContainer.appendChild(expenseDiv);

            // Add event listeners
            expenseDiv.querySelector('.expense-name').addEventListener('input', calculateSummary);
            expenseDiv.querySelector('.expense-amount').addEventListener('input', calculateSummary);
            expenseDiv.querySelector('.expense-type').addEventListener('change', calculateSummary);
            expenseDiv.querySelector('.remove-expense-btn').addEventListener('click', () => {
                expensesContainer.removeChild(expenseDiv);
                currentMonthExpenses = currentMonthExpenses.filter(item => item !== expenseDiv); // Remove from tracking array
                calculateSummary();
            });

            if (!isInitialLoad) {
                calculateSummary(); // Recalculate summary after adding a new empty expense
            }
        }

        addExpenseBtn.addEventListener('click', () => addExpenseInput());
        incomeInput.addEventListener('input', calculateSummary);

        function calculateSummary() {
            const income = parseFloat(incomeInput.value) || 0;
            let totalExpenses = 0;

            currentMonthExpenses.forEach(expenseDiv => {
                const amountInput = expenseDiv.querySelector('.expense-amount');
                const typeSelect = expenseDiv.querySelector('.expense-type');

                let amount = parseFloat(amountInput.value) || 0;
                const type = typeSelect.value;

                if (type === 'percentage') {
                    totalExpenses += (income * (amount / 100));
                } else {
                    totalExpenses += amount;
                }
            });

            const remainingBalance = income - totalExpenses;

            totalExpensesSpan.textContent = formatCurrency(totalExpenses);
            remainingBalanceSpan.textContent = formatCurrency(remainingBalance);

            // Apply color to remaining balance based on value
            if (remainingBalance < 0) {
                remainingBalanceSpan.classList.remove('text-green-600');
                remainingBalanceSpan.classList.add('text-red-600');
            } else {
                remainingBalanceSpan.classList.remove('text-red-600');
                remainingBalanceSpan.classList.add('text-green-600');
            }
        }

        function loadCurrentMonthBudget() {
            const currentMonthKey = getSelectedMonthKey();
            displayCurrentMonthName(); // Update display immediately when month/year changes
            const currentBudget = budgets[currentMonthKey];

            // Clear previous inputs
            expensesContainer.innerHTML = '';
            currentMonthExpenses = [];

            if (currentBudget) {
                incomeInput.value = currentBudget.income;
                currentBudget.expenses.forEach(expense => addExpenseInput(expense, true));
            } else {
                incomeInput.value = '';
                addExpenseInput(); // Add one default expense input if no budget exists
            }
            calculateSummary();
        }

        saveBudgetBtn.addEventListener('click', () => {
            const currentMonthKey = getSelectedMonthKey();
            if (!currentMonthKey) {
                alertUser('Please select a month and year before saving.', 'red');
                return;
            }
            const income = parseFloat(incomeInput.value) || 0;
            const expenses = [];

            currentMonthExpenses.forEach(expenseDiv => {
                const nameInput = expenseDiv.querySelector('.expense-name');
                const amountInput = expenseDiv.querySelector('.expense-amount');
                const typeSelect = expenseDiv.querySelector('.expense-type');

                const name = nameInput.value.trim();
                const amount = parseFloat(amountInput.value) || 0;
                const type = typeSelect.value;

                if (name && (amount > 0 || type === 'percentage')) { // Only save valid expenses
                    expenses.push({ name, amount, type });
                }
            });

            // Calculate total expenses and balance for saving
            let totalExpenses = 0;
            expenses.forEach(expense => {
                if (expense.type === 'percentage') {
                    totalExpenses += (income * (expense.amount / 100));
                } else {
                    totalExpenses += expense.amount;
                }
            });
            const balance = income - totalExpenses;

            budgets[currentMonthKey] = {
                income: income,
                expenses: expenses,
                totalExpenses: totalExpenses,
                balance: balance
            };

            saveBudgets(budgets);
            alertUser('Budget saved successfully!', 'green');
            updateSpendingChart(); // Update chart after saving current month
            populateHistoryDropdown(); // Update dropdown with new month if it's the first time
        });

        // --- Spending History & Previous Months Logic ---
        const historyMonthSelect = document.getElementById('historyMonthSelect');
        const selectedMonthDetails = document.getElementById('selectedMonthDetails');
        const detailsMonthDisplay = document.getElementById('detailsMonthDisplay');
        const detailsIncome = document.getElementById('detailsIncome');
        const detailsExpensesContainer = document.getElementById('detailsExpensesContainer');
        const addHistoryExpenseBtn = document.getElementById('addHistoryExpenseBtn');
        const saveHistoryBudgetBtn = document.getElementById('saveHistoryBudgetBtn');

        let historyMonthExpenses = []; // To track expense inputs in the history section

        function populateHistoryDropdown() {
            historyMonthSelect.innerHTML = ''; // Clear existing options
            const monthKeys = Object.keys(budgets).sort().reverse(); // Sort descending for most recent first

            if (monthKeys.length === 0) {
                historyMonthSelect.innerHTML = '<option value="">No historical data</option>';
                selectedMonthDetails.classList.add('hidden');
                return;
            }

            monthKeys.forEach(key => {
                const option = document.createElement('option');
                option.value = key;
                const [year, month] = key.split('-');
                const date = new Date(year, parseInt(month) - 1, 1); // Month is 0-indexed
                option.textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
                historyMonthSelect.appendChild(option);
            });

            // Automatically select the first (most recent) month and display its details
            if (monthKeys.length > 0) {
                historyMonthSelect.value = monthKeys[0];
                displaySelectedMonthDetails();
            }
        }

        historyMonthSelect.addEventListener('change', displaySelectedMonthDetails);

        function displaySelectedMonthDetails() {
            const selectedKey = historyMonthSelect.value;
            const budgetData = budgets[selectedKey];

            if (!budgetData) {
                selectedMonthDetails.classList.add('hidden');
                return;
            }

            selectedMonthDetails.classList.remove('hidden');
            const [year, month] = selectedKey.split('-');
            const date = new Date(year, parseInt(month) - 1, 1);
            detailsMonthDisplay.textContent = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
            detailsIncome.textContent = formatCurrency(budgetData.income);

            // Clear previous history expense inputs
            detailsExpensesContainer.innerHTML = '';
            historyMonthExpenses = [];

            // Populate expense inputs for the selected month
            budgetData.expenses.forEach(expense => addHistoryExpenseInput(expense));

            // Attach event listeners for calculating summary on history inputs (for current view, not saving yet)
            detailsExpensesContainer.querySelectorAll('.history-expense-name, .history-expense-amount, .history-expense-type').forEach(input => {
                input.addEventListener('input', calculateHistorySummary);
                input.addEventListener('change', calculateHistorySummary); // For select change
            });
            calculateHistorySummary(); // Initial calculation for history view
        }

        function addHistoryExpenseInput(expense = { name: '', amount: '', type: 'value' }) {
            const expenseDiv = document.createElement('div');
            expenseDiv.className = 'flex flex-col sm:flex-row gap-2 items-end sm:items-center';

            const expenseIndex = historyMonthExpenses.length;
            historyMonthExpenses.push(expenseDiv); // Add to tracking array

            expenseDiv.innerHTML = `
                <input type="text" placeholder="Expense Name" value="${expense.name}" class="history-expense-name flex-1 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                <input type="number" placeholder="Amount" value="${expense.amount}" step="0.01" class="history-expense-amount w-24 p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                <select class="history-expense-type p-2 rounded-md focus:outline-none focus:ring-2 focus:ring-purple-500">
                    <option value="value" ${expense.type === 'value' ? 'selected' : ''}>$</option>
                    <option value="percentage" ${expense.type === 'percentage' ? 'selected' : ''}>%</option>
                </select>
                <button class="remove-history-expense-btn bg-red-500 text-white p-2 rounded-md hover:bg-red-600 focus:outline-none focus:ring-2 focus:ring-red-500 remove-btn-symbol">&times;</button>
            `;
            detailsExpensesContainer.appendChild(expenseDiv);

            // Add event listeners for this specific input row
            expenseDiv.querySelector('.history-expense-name').addEventListener('input', calculateHistorySummary);
            expenseDiv.querySelector('.history-expense-amount').addEventListener('input', calculateHistorySummary);
            expenseDiv.querySelector('.history-expense-type').addEventListener('change', calculateHistorySummary);
            expenseDiv.querySelector('.remove-history-expense-btn').addEventListener('click', () => {
                detailsExpensesContainer.removeChild(expenseDiv);
                historyMonthExpenses = historyMonthExpenses.filter(item => item !== expenseDiv); // Remove from tracking
                calculateHistorySummary();
            });
        }

        addHistoryExpenseBtn.addEventListener('click', () => addHistoryExpenseInput());

        function calculateHistorySummary() {
            // This function is for display purposes in the history editing section.
            // It recalculates the summary based on the *currently edited* values,
            // but doesn't update the main total expenses/balance spans.
            const selectedKey = historyMonthSelect.value;
            const currentMonthBudget = budgets[selectedKey] || { income: 0, expenses: [] };

            const income = currentMonthBudget.income || 0; // Income is taken from the saved budget for that month

            let totalExpenses = 0;
            historyMonthExpenses.forEach(expenseDiv => {
                const amountInput = expenseDiv.querySelector('.history-expense-amount');
                const typeSelect = expenseDiv.querySelector('.history-expense-type');

                let amount = parseFloat(amountInput.value) || 0;
                const type = typeSelect.value;

                if (type === 'percentage') {
                    totalExpenses += (income * (amount / 100));
                } else {
                    totalExpenses += amount;
                }
            });

            // If you want to display an updated summary *within* the history details section:
            // You would need to add new <p> elements for "Total Expenses" and "Remaining Balance"
            // specifically for the history view, similar to the current month's summary.
            // For now, this calculation happens to prepare data for `saveHistoryBudgetBtn`.
        }

        saveHistoryBudgetBtn.addEventListener('click', () => {
            const selectedKey = historyMonthSelect.value;
            if (!selectedKey) {
                alertUser('Please select a month to save changes.', 'red');
                return;
            }

            const currentBudgetForMonth = budgets[selectedKey] || { income: 0 };
            const income = currentBudgetForMonth.income; // Income is taken from the saved budget for that month

            const updatedExpenses = [];
            historyMonthExpenses.forEach(expenseDiv => {
                const nameInput = expenseDiv.querySelector('.history-expense-name');
                const amountInput = expenseDiv.querySelector('.history-expense-amount');
                const typeSelect = expenseDiv.querySelector('.history-expense-type');

                const name = nameInput.value.trim();
                const amount = parseFloat(amountInput.value) || 0;
                const type = typeSelect.value;

                if (name && (amount > 0 || type === 'percentage')) { // Only save valid expenses
                    updatedExpenses.push({ name, amount, type });
                }
            });

            // Recalculate total expenses and balance based on updated expenses
            let totalExpenses = 0;
            updatedExpenses.forEach(expense => {
                if (expense.type === 'percentage') {
                    totalExpenses += (income * (expense.amount / 100));
                } else {
                    totalExpenses += expense.amount;
                }
            });
            const balance = income - totalExpenses;

            budgets[selectedKey] = {
                income: income,
                expenses: updatedExpenses,
                totalExpenses: totalExpenses,
                balance: balance
            };

            saveBudgets(budgets);
            alertUser(`Changes for ${selectedKey} saved successfully!`, 'green');
            updateSpendingChart(); // Update chart after saving history changes
            displaySelectedMonthDetails(); // Re-display with updated data
        });

        // --- Chart.js Logic ---
        const ctx = document.getElementById('spendingChart').getContext('2d');

        function updateSpendingChart() {
            const labels = [];
            const incomeData = [];
            const expensesData = [];
            const balanceData = [];

            // Sort budget keys chronologically
            const sortedKeys = Object.keys(budgets).sort();

            sortedKeys.forEach(key => {
                const budget = budgets[key];
                const [year, month] = key.split('-');
                const date = new Date(year, parseInt(month) - 1, 1);
                labels.push(date.toLocaleDateString('en-US', { month: 'short', year: '2-digit' }));
                incomeData.push(budget.income);
                expensesData.push(budget.totalExpenses);
                balanceData.push(budget.balance);
            });

            const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
            const textColor = currentTheme === 'dark' ? '#e2e8f0' : '#1f2937'; // Light text for dark, dark for light
            const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'; // Lighter grid for dark

            const chartConfig = {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Income',
                            data: incomeData,
                            borderColor: '#3b82f6', // Blue-500
                            backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Total Expenses',
                            data: expensesData,
                            borderColor: '#ef4444', // Red-500
                            backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            tension: 0.3,
                            fill: false
                        },
                        {
                            label: 'Remaining Balance',
                            data: balanceData,
                            borderColor: '#22c55e', // Green-500
                            backgroundColor: 'rgba(34, 197, 94, 0.2)',
                            tension: 0.3,
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: textColor // Legend text color
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: textColor // X-axis label color
                            },
                            grid: {
                                color: gridColor // X-axis grid line color
                            }
                        },
                        y: {
                            ticks: {
                                color: textColor, // Y-axis label color
                                callback: function(value) {
                                    return formatCurrency(value); // Format Y-axis labels as currency
                                }
                            },
                            grid: {
                                color: gridColor // Y-axis grid line color
                            }
                        }
                    }
                }
            };

            if (spendingChart) {
                spendingChart.data = chartConfig.data;
                spendingChart.options = chartConfig.options;
                spendingChart.update();
            } else {
                spendingChart = new Chart(ctx, chartConfig);
            }
        }

        // Function to update chart theme (called when dark mode changes)
        function updateChartTheme() {
            if (spendingChart) {
                const currentTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
                const textColor = currentTheme === 'dark' ? '#e2e8f0' : '#1f2937';
                const gridColor = currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';

                spendingChart.options.plugins.legend.labels.color = textColor;
                spendingChart.options.scales.x.ticks.color = textColor;
                spendingChart.options.scales.x.grid.color = gridColor;
                spendingChart.options.scales.y.ticks.color = textColor;
                spendingChart.options.scales.y.grid.color = gridColor;

                spendingChart.update();
            }
        }

        // --- Message Box Function (instead of alert) ---
        function alertUser(message, type = 'blue') {
            const messageBox = document.createElement('div');
            messageBox.className = `fixed top-4 right-4 p-4 rounded-md text-white shadow-lg z-50 animate-fade-in`;

            let bgColor = '';
            if (type === 'green') {
                bgColor = 'bg-green-500';
            } else if (type === 'red') {
                bgColor = 'bg-red-500';
            } else {
                bgColor = 'bg-blue-500';
            }

            messageBox.classList.add(bgColor);
            messageBox.textContent = message;

            document.body.appendChild(messageBox);

            // Optional: Add a simple fade-out animation and remove
            setTimeout(() => {
                messageBox.classList.add('animate-fade-out');
                messageBox.addEventListener('animationend', () => messageBox.remove());
            }, 3000); // Display for 3 seconds
        }

        // Initial loads and setup
        populateMonthYearDropdowns(); // Populate the new month/year dropdowns
        loadCurrentMonthBudget(); // Loads or initializes current month inputs based on selected month/year
        populateHistoryDropdown(); // Populates dropdown with existing months
        updateSpendingChart(); // Renders the chart
    </script>
</body>
</html>
